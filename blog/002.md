# 20251209服务器故障处理记录

两个问题：
其一，服务器无作业，但CPU占用率99%，用户尝试提交作业，一分钟内被自动终止，无报错信息。用户cp或zip文件，文件较小时能成功，文件较大时自动终止，返回Killed。
其二，在解决上述问题是，尝试主机重启。但显示器始终黑屏。但指示灯亮，硬盘灯闪烁。ping不上主机，也无法ssh连接上主机

分析：经售后技术人员查看，问题一可能是中病毒或者被人占用挖矿了。问题二是因为VGA接口虚焊。两者综合在一起导致无法重装系统。至于为何ping不上主机，暂时不明。

解决：
1. 使用BMC技术开启桌面
维修主板要耽误时间，故通过BMC技术连接主机。这部分配置由售后人员操作，我观察到的步骤大致如下：从主板上读取IMPI账号密码，网线连接笔记本和主机的管理端口，手动设置以太网IP字段，使用tiny pxw server软件设置BMC转发ip，浏览器打开ip即可进入控制台，开启KVM。

2. 重装Rocky linux 9.7

官网下载镜像，Rufus制作启动U盘。开机按Del键进入BIOS，调整Boot优先级到USB。保存并退出。
成功安装Anacodna，进入引导GUI。
设置语言，设置时区键盘，设置root密码，调整硬盘分区，设置主机名。设置主机名在Newwork&Hostname部分，无高亮提醒，容易遗漏，需注意。
分区时，选择1TB的三星SSD作为系统盘，另一个7T的资料盘不用选择。选择“Custom”手动分区，否则会因为原来的系统已经占满空间而失败。进入手动分区页面，选择原系统下分区按减号删除原有系统。使用LVM方法，自动建立新分区，根目录（/）默认70G，从home里分30G给它，以免后面/usr/local下的软件太多爆盘，其余大小不用调整。此时窗口提示，“设备开启了SMT技术不安全”，后面我们再处理它。
开始安装。结束后点击重启系统，屏幕进入到[terminated]的界面，取出系统盘，关电源重启即可。
重启时再次进入BIOS，将Boot优先级调至新系统对应的硬盘。在CPU/Performance里关闭SMT超线程技术。
进入新系统页面，新建完用户。
新建终端，sudo echo 1，确认一下用户有sudo权限。用group看自己是否在wheel组里也行。（Debian系列的组名就叫sudo，红帽系列为wheel）。
lsblk && df -h，能看到7T的资料盘名称叫sda1，并且没有挂载到任何目录。sudo mkdir /data创建文件夹，sudo mount /dev/sda1 /data，将7T资料盘挂载上。此时ls /data 应该能看到备份文件都在。
ifconfig，记一下ip地址，方便后面SSH连远程（可直接写在机箱上）。
浏览器进入wlrz.fduan.edu.cn。连上学校内网。终端ping baidu.com，测试是否通网。
回到笔记本，用SSH试试连接主机（我用的vscode的SSH-Remote扩展）。如果重装系统前后的主机名用户名和ip都一样，笔记本的ssh可能保存的是之前的公钥，终端里ssh @ip会返回Host key verification failed相关字样，用ssh-keygen -R ip命令可清除。
后面可以在个人笔记本上远程访问服务器了。需要GUI时再用BMC连接。

1. 配置slurm
网上教程基本都是教你手动编译，手动编译依赖库，至今没遇见能完美走通的教程。
经高手操作一遍，学到了一招——从Rocky linux的官方仓库下载。傻瓜式安装。
（其实最开始我试过dnf install slurm，但没考虑到新装的系统，只有最基础的仓库，还以为这破软件非得手动编译）
```
sudo -i
dnf install epel-release //添加企业仓库，是避免手动编译slurm的关键
dnf search slurm #确认能找到slurm仓库
dnf install slurm slurm-slurmd slurm-slurmctld

slurmd -C #返回主机配置信息，复制第一行
nano /etc/slurm/slurm.conf #将倒数第二行改成上面复制的，其他先不动。

/usr/sbin/create-munge-key #生成munge.key

#启动服务
systemctl start munge
systemctl start slurmctld
systemctl start slurmd

#设置开机自启动
systemctl enable --now munge
systemctl enable --now slurmctld
systemctl enable --now slurmd
```
到了此时，如果尝试 srun hostname，会显示 Required node not availale，sinfo会发现节点是down状态。

```

```
1. 安装g16

2. 配python环境

3. 安装VASP
todo
1. 安装CP2K
todo